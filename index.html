<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="韭黄溯源系统首页，展示区块链食品安全学习任务、用户进度与实时行业资讯。" />
  <title>首页 - 韭黄溯源系统</title>
  <style>
    :root {
      --bg: #050a18;
      --bg-alt: #0b1430;
      --card: rgba(14, 23, 47, 0.78);
      --card-solid: #101b36;
      --accent: #60a5fa;
      --accent-strong: #38bdf8;
      --accent-soft: rgba(96, 165, 250, 0.16);
      --warn: #f97316;
      --success: #34d399;
      --muted: #94a3b8;
      --text: #f8fafc;
      --radius-lg: 22px;
      --radius-md: 16px;
      --shadow: 0 28px 70px rgba(8, 13, 35, 0.55);
      --font-sans: "Inter", "HarmonyOS Sans", "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      --gradient-primary: linear-gradient(135deg, rgba(59, 130, 246, 0.92), rgba(14, 165, 233, 0.88));
      --gradient-secondary: linear-gradient(135deg, rgba(248, 113, 113, 0.9), rgba(249, 115, 22, 0.9));
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-sans);
      color: var(--text);
      background:
        radial-gradient(circle at -10% 0%, rgba(59, 130, 246, 0.18), transparent 55%),
        radial-gradient(circle at 110% 15%, rgba(14, 165, 233, 0.2), transparent 45%),
        linear-gradient(165deg, var(--bg) 5%, #07112a 52%, var(--bg) 95%);
      display: flex;
      justify-content: center;
      padding: 54px 20px 68px;
    }

    main {
      width: min(1130px, 100%);
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .panel {
      background: var(--card);
      backdrop-filter: blur(28px);
      border-radius: var(--radius-lg);
      padding: 36px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.14);
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 0.9fr);
      gap: 38px;
      align-items: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: rgba(59, 130, 246, 0.12);
      color: var(--accent-strong);
      border-radius: 999px;
      font-size: 13px;
      letter-spacing: 0.4px;
    }

    h1 {
      margin: 18px 0 16px;
      font-size: clamp(28px, 4.2vw, 40px);
      line-height: 1.22;
    }

    p { margin: 0 0 14px; color: var(--muted); line-height: 1.7; }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: 20px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 13px 22px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 15px;
      text-decoration: none;
      border: none;
      color: #fff;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
      box-shadow: 0 12px 28px rgba(59, 130, 246, 0.28);
      background: var(--gradient-primary);
    }

    .btn.secondary {
      background: rgba(96, 165, 250, 0.14);
      color: #dbeafe;
      box-shadow: inset 0 0 0 1px rgba(96, 165, 250, 0.35);
    }

    .btn.highlight {
      background: var(--gradient-secondary);
      box-shadow: 0 12px 28px rgba(249, 115, 22, 0.24);
    }

    .btn.warn {
      background: rgba(248, 113, 113, 0.22);
      color: #fee2e2;
      box-shadow: inset 0 0 0 1px rgba(248, 113, 113, 0.4);
    }

    .btn:hover { transform: translateY(-2px); opacity: 0.94; }

    .feature-points {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 16px;
      margin-top: 28px;
    }

    .feature-card {
      background: rgba(15, 23, 42, 0.58);
      border: 1px solid rgba(96, 165, 250, 0.18);
      border-radius: var(--radius-md);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .feature-card strong { font-size: 16px; color: #dbeafe; }
    .feature-card span { font-size: 13px; color: var(--muted); line-height: 1.65; }

    .hero-side {
      background: var(--card-solid);
      border-radius: var(--radius-md);
      padding: 26px 28px;
      border: 1px solid rgba(59, 130, 246, 0.22);
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-shadow: inset 0 0 28px rgba(12, 21, 41, 0.48);
    }

    .hero-side h2 {
      margin: 0;
      font-size: 20px;
    }

    .stat-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: rgba(30, 41, 59, 0.65);
      border-radius: 14px;
      padding: 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .stat-card div { font-size: 13px; color: var(--muted); }
    .stat-card strong { display: block; margin-top: 10px; font-size: 24px; color: #e2e8f0; }

    .dashboard { display: none; flex-direction: column; gap: 26px; }
    .dashboard.active { display: flex; }

    .section-title {
      margin: 0 0 12px;
      font-size: 22px;
    }

    .question-list { display: flex; flex-direction: column; gap: 20px; margin-top: 16px; }
    .question-card {
      background: rgba(16, 24, 48, 0.82);
      border-radius: var(--radius-md);
      padding: 20px 22px;
      border: 1px solid rgba(96, 165, 250, 0.2);
    }

    .question-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #e0f2fe;
    }

    .question-meta { font-size: 14px; color: var(--muted); line-height: 1.7; margin: 0 0 12px; }
    .question-hint { color: #bae6fd; }

    textarea {
      width: 100%;
      min-height: 126px;
      border-radius: 14px;
      padding: 14px;
      background: rgba(9, 15, 32, 0.88);
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, 0.32);
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    textarea:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.9);
      box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.22);
    }

    .status {
      text-align: right;
      font-size: 13px;
      color: rgba(144, 205, 244, 0.92);
      min-height: 18px;
    }

    .news-list { list-style: none; padding: 0; margin: 24px 0 0; display: flex; flex-direction: column; gap: 14px; }
    .news-item {
      background: rgba(15, 23, 42, 0.6);
      padding: 16px 18px;
      border-radius: 16px;
      border: 1px solid rgba(59, 130, 246, 0.16);
    }

    .news-item a {
      color: #dbeafe;
      font-weight: 600;
      font-size: 15px;
      text-decoration: none;
    }

    .news-item a:hover { text-decoration: underline; }

    .news-meta { margin-top: 8px; font-size: 13px; color: var(--muted); }

    .tips-list {
      margin: 12px 0 0 18px;
      color: var(--muted);
      line-height: 1.75;
      font-size: 14px;
    }

    @media (max-width: 960px) {
      body { padding: 32px 16px 42px; }
      .panel { padding: 26px; border-radius: 18px; }
      .hero-grid { grid-template-columns: 1fr; gap: 28px; }
      .actions { flex-direction: column; align-items: stretch; }
      .hero-side { padding: 24px; }
    }

    @media (max-width: 640px) {
      main { gap: 22px; }
      .panel { padding: 24px; }
      textarea { min-height: 110px; }
    }
  </style>
</head>
<body>
  <main>
    <section id="guest" class="panel">
      <div class="hero-grid">
        <div class="hero-copy">
          <span class="badge">韭黄溯源系统 · 区块链实践课堂</span>
          <h1>让产地到餐桌透明可见，一站式掌握区块链食品安全方案</h1>
          <p>
            登录后即可领取区块链食品安全专题任务，按照流程体验数据上链、协同监管与应急响应等模块，
            打造真实的“韭黄产业数字化”综合案例。
          </p>
          <div class="actions">
            <a class="btn" href="login.html">立即登录</a>
            <a class="btn secondary" href="register.html">注册新账号</a>
            <a class="btn highlight" href="https://jiuhuang.pages.dev/" target="_blank" rel="noopener">访问演示站点</a>
          </div>
          <div class="feature-points">
            <div class="feature-card">
              <strong>全链路可信</strong>
              <span>记录种植档案、质检证明、冷链流向到零售验真，信息一链到底。</span>
            </div>
            <div class="feature-card">
              <strong>监管协同</strong>
              <span>农业农村部、市场监管总局、地方应急等多部门共享链上数据。</span>
            </div>
            <div class="feature-card">
              <strong>事件预警</strong>
              <span>结合 AI 舆情与温控监测，提前锁定潜在风险批次。</span>
            </div>
          </div>
        </div>
        <aside class="hero-side">
          <h2>体验亮点</h2>
          <div class="stat-list">
            <div class="stat-card">
              <div>覆盖业务节点</div>
              <strong>12+</strong>
            </div>
            <div class="stat-card">
              <div>模拟监管流程</div>
              <strong>5 套</strong>
            </div>
            <div class="stat-card">
              <div>最新行业资讯</div>
              <strong>实时</strong>
            </div>
          </div>
          <p style="margin: 4px 0 0; font-size: 13px;">
            课程适合希望了解农产品溯源、区块链底层设计与协同监管机制的同学。
          </p>
        </aside>
      </div>
    </section>

    <section id="dashboard" class="dashboard">
      <section class="panel" style="display: flex; flex-direction: column; gap: 18px;">
        <header>
          <span class="badge">欢迎回来</span>
          <h1 style="margin: 14px 0 10px;">你好，<span id="user-name"></span></h1>
          <p style="margin: 0;">
            以下为你的专题任务。我们会自动保存草稿，完成后可与同学分享成果，共同完善韭黄产业链治理方案。
          </p>
        </header>
        <div style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: space-between; align-items: center;">
          <span style="font-size: 14px; color: var(--muted);">登录邮箱：<span id="user-email"></span></span>
          <button id="logout-btn" class="btn warn" type="button">退出登录</button>
        </div>
      </section>

      <section class="panel">
        <h2 class="section-title">区块链 + 韭黄产业专题研讨</h2>
        <p style="margin-bottom: 0;">
          每道题支持分段撰写，我们会自动同步到浏览器本地存储，换设备后也能一眼查看历史思路。
        </p>
        <div id="question-list" class="question-list"></div>
        <div id="save-status" class="status"></div>
      </section>

      <section class="panel">
        <h2 class="section-title">参考要点</h2>
        <ul class="tips-list">
          <li>聚焦韭黄供应链，覆盖“种植—检测—冷链—批发—零售”关键节点。</li>
          <li>善用联盟链治理、可信上传、隐私计算等手段应对数据可信与隐私挑战。</li>
          <li>分析企业落地成本、标准不统一、跨部门协同等痛点并给出缓解路径。</li>
          <li>结合舆情监测、AI 预警、应急溯源快速生成处置建议。</li>
        </ul>
      </section>
    </section>

    <section class="panel" id="news-card">
      <h2 class="section-title" style="margin-bottom: 6px;">区块链与农业食品最新资讯</h2>
      <p style="margin: 0;">
        资讯来自巴比特、金色财经、链闻等可信渠道，默认每 30 分钟自动刷新，确保课堂案例紧贴一线动态。
      </p>
      <ul id="news-list" class="news-list">
        <li id="news-placeholder" class="news-item">
          正在获取最新资讯，请稍候...
          <div class="news-meta">若长时间未加载，可刷新页面或稍后重试。</div>
        </li>
      </ul>
      <div id="news-status" class="news-meta" style="margin-top: 18px;"></div>
    </section>
  </main>

  <script>
    const guestSection = document.getElementById('guest')
    const dashboard = document.getElementById('dashboard')
    const questionList = document.getElementById('question-list')
    const statusEl = document.getElementById('save-status')
    const logoutBtn = document.getElementById('logout-btn')
    const userNameEl = document.getElementById('user-name')
    const userEmailEl = document.getElementById('user-email')
    const newsList = document.getElementById('news-list')
    const newsStatus = document.getElementById('news-status')

    const NEWS_REFRESH_MS = 30 * 60 * 1000
    let newsTimer = 0

    const questions = [
      {
        title: '1. 如何利用区块链提升韭黄供应链的透明度？',
        prompt:
          '描述从种植端到消费端的关键数据点（种植档案、检测报告、冷链温控、交接记录、终端扫码等），分析哪些信息需要上链，以及突发食品安全事件中如何快速锁定问题批次。',
        hint: '考虑链上链下协同、物联网设备可信上传、扫描验真等环节。',
      },
      {
        title: '2. 在我国监管体系下如何实现跨部门协同治理？',
        prompt:
          '举例说明农业农村部、市场监管总局、地方应急管理、海关等角色如何共享链上数据，实现联合监管与快速响应。',
        hint: '可以结合智慧监管、预警联动、稽核追责等场景。',
      },
      {
        title: '3. 落地过程中会遇到哪些挑战？如何应对？',
        prompt:
          '围绕企业上链成本、数据真实性、隐私保护、标准不统一等问题，提出可行的技术或治理方案。',
        hint: '可从联盟链治理、财政补贴、隐私计算、标准制定等角度展开。',
      },
    ]

    function storageKey(username) {
      return `jiuhuangweb3-answers-${username.toLowerCase()}`
    }

    function renderQuestions(answers) {
      questionList.innerHTML = ''
      questions.forEach((q, index) => {
        const card = document.createElement('article')
        card.className = 'question-card'
        card.innerHTML = `
          <h3>${q.title}</h3>
          <div class="question-meta">${q.prompt}</div>
          <div class="question-meta question-hint">提示：${q.hint}</div>
        `
        const textarea = document.createElement('textarea')
        textarea.name = `answer-${index}`
        textarea.placeholder = '在这里记录你的思路、案例或参考数据……'
        textarea.value = answers[index] || ''
        textarea.dataset.index = String(index)
        card.appendChild(textarea)
        questionList.appendChild(card)
      })
    }

    function attachAutosave(username) {
      const key = storageKey(username)
      let timer = 0
      const updateStatus = text => {
        statusEl.textContent = text
        if (text) {
          window.setTimeout(() => {
            if (statusEl.textContent === text) statusEl.textContent = ''
          }, 2200)
        }
      }
      questionList.addEventListener('input', event => {
        if (!(event.target instanceof HTMLTextAreaElement)) return
        const answers = Array.from(questionList.querySelectorAll('textarea')).map(t => t.value.trim())
        window.clearTimeout(timer)
        timer = window.setTimeout(() => {
          localStorage.setItem(key, JSON.stringify(answers))
          updateStatus('草稿已同步到浏览器')
        }, 420)
      })
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/logout', { method: 'POST', credentials: 'include' })
          } finally {
            window.location.reload()
          }
        })
      }
    }

    async function initDashboard() {
      try {
        const res = await fetch('/session', { credentials: 'include' })
        if (!res.ok) throw new Error('未登录')
        const data = await res.json()
        if (!data.ok || !data.user) throw new Error('用户信息缺失')

        const user = data.user
        userNameEl.textContent = user.username
        userEmailEl.textContent = user.email

        const saved = localStorage.getItem(storageKey(user.username))
        const answers = saved ? JSON.parse(saved) : []

        renderQuestions(answers)
        attachAutosave(user.username)

        guestSection.style.display = 'none'
        dashboard.classList.add('active')
      } catch (err) {
        console.info('未登录状态，展示访客视图', err)
        guestSection.style.display = 'block'
        dashboard.classList.remove('active')
      }
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('zh-CN', {
        hour12: false,
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      }).format(date)
    }

    function updateNewsStatus({ updatedAt, stale, error }) {
      const parts = []
      if (updatedAt) parts.push(`最后更新：${formatDate(updatedAt)}`)
      parts.push('约每 30 分钟刷新一次')
      if (stale) parts.push('当前展示缓存数据')
      if (error) parts.push(`抓取异常：${error}`)
      newsStatus.textContent = parts.join(' ｜ ')
    }

    function scheduleNewsRefresh() {
      window.clearInterval(newsTimer)
      newsTimer = window.setInterval(loadNews, NEWS_REFRESH_MS)
    }

    async function loadNews() {
      try {
        const res = await fetch('/news', { cache: 'no-store' })
        if (!res.ok) throw new Error(res.statusText || '加载失败')
        const data = await res.json()
        if (!data.ok || !Array.isArray(data.items)) throw new Error('数据格式错误')

        const isStale = res.headers.get('x-news-stale') === '1'
        const warning = res.headers.get('x-news-error') || ''
        const generatedAt = data.generatedAt ? new Date(data.generatedAt) : new Date()

        newsList.innerHTML = ''
        if (!data.items.length) {
          const li = document.createElement('li')
          li.className = 'news-item'
          li.innerHTML = '<strong>暂未抓取到最新资讯。</strong><div class="news-meta">请稍后再试，或关注官方渠道。</div>'
          newsList.appendChild(li)
        } else {
          data.items.slice(0, 9).forEach(item => {
            const li = document.createElement('li')
            li.className = 'news-item'
            li.innerHTML = `
              <a href="${item.link}" target="_blank" rel="noopener">${item.title}</a>
              <div class="news-meta">${new Date(item.published).toLocaleString('zh-CN')} · ${item.source}</div>
            `
            newsList.appendChild(li)
          })
        }

        updateNewsStatus({ updatedAt: generatedAt, stale: isStale, error: warning })
        scheduleNewsRefresh()
      } catch (err) {
        newsList.innerHTML = `
          <li class="news-item">
            暂时无法加载资讯，请稍后重试。
            <div class="news-meta">${String(err)}</div>
          </li>
        `
        updateNewsStatus({ updatedAt: null, stale: false, error: String(err) })
        scheduleNewsRefresh()
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        loadNews()
      }
    })

    initDashboard()
    loadNews()
  </script>
</body>
</html>
